{% extends 'includes/sidebar.html.twig' %}

{% block title %}Asitur{% endblock %}

{% block stylesheets %}
{{parent()}}
    <link rel="stylesheet" href="{{ asset('css/frontend/style-data_management.css') }}">
    <link rel="stylesheet" href="{{ asset('css/frontend/style-asitur_datatable.css') }}">

    <style>
        @media (max-width: 767px) {
            #operator_data_body_inner_row_div {
                display: flex;
                flex-direction: column-reverse;
                margin-top: 0;
            }

            #profile_img_div {
                right: 0;
                position: absolute;
            }
        }

        #changePasswordContent{
            display: none;
        }

        .new-button:hover {
            color: var(--main-blue);
        }

        .new-button:active {
            background-color: var(--main-blue);
            color: white;
        }

        .new-button:active img {
            filter: grayscale(100%) brightness(200%);
        }

        .new-button:disabled {
            border-color: var(--main-lightgrey) !important;
        }

        @media (max-width: 500px) {
            #profile_img_div {
                float: unset !important;
                position: relative;
            }
        }
    </style>
}

{% endblock %}

{% block content %}

    <!--Page Title-->
    <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
    <div id="page-title">
        <ul class="nav nav-tabs nav-justified">
            <li class="nav-item col-md-4">
                <a class="nav-link" href="{{ path('branch_offices') }}">{{"data_management.tab.branch_offices"|trans}}</a>
            </li>
            <li class="nav-item col-md-4">
                <a class="nav-link" href="{{ path('cranes') }}">{{"data_management.tab.cranes"|trans}}</a>
            </li>
            <li class="nav-item col-md-4">
                <a class="nav-link active">{{"data_management.tab.operators"|trans}}</a>
                <hr class="tab-active-hr">
            </li>
        </ul>
    </div>
    <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
    <!--End page title-->

    <!--Page content-->
    <!--===================================================-->
    <div id="page-content">

        {# Bloque de botones de la parte superior de la tabla #}
        <div class="filters_and_buttons" style="padding: 0; display: flex; justify-content: space-between; margin-bottom: 25px;">
            <div id="top_left_div" style="padding: 0;">
                {# Volver #}
                <a class="go_back_link" href="{{ path('operators') }}"><i class="fa fa-2x fa-chevron-left"></i>{{"general.go_back_to_list"|trans}}</a>
                {# Editar #}
                {% if mode == "read_only" %}
                    <form id="edit_form" action="{{ path('detail_operator') }}" method="POST" style="display: none;">
                        <input type="hidden" name="operatorId" value="{{ operator.id }}">
                        <input type="hidden" name="mode" value="edit_allowed">
                    </form>
                    <button type="button" class="btn top_left-buttons edit-button"> <img src="{{asset("media/datatables/lapiz-icono.png")}}" width="17px" height="18px"> &nbsp; {{('dataTable.asitur.edit')|trans}}</button>
                {% else %}
                    <button disabled type="button" class="btn top_left-buttons edit-button" style="font-weight: bold; color: var(--main-blue); opacity: 1; filter: var(--filter-main-blue);"> <img src="{{asset("media/datatables/lapiz-icono.png")}}" width="17px" height="18px"> &nbsp; {{('dataTable.asitur.edit')|trans}}</button>
                {% endif %}
                {# Eliminar #}
                <button type="button" class="btn top_left-buttons remove-button"> <img src="{{asset("media/datatables/basura-icono.png")}}" width="17px" height="18px"> &nbsp; {{('dataTable.asitur.remove')|trans}}</button>
                {# Exportar #}
                <button type="button" class="btn top_left-buttons export-button"> <img src="{{asset("media/datatables/export.png")}}" width="17px" height="18px"> &nbsp; {{('dataTable.asitur.export')|trans}}</button>
            </div>
            {% if mode == "edit_allowed" %}
            <div id="top_right_div" style="padding: 0; border-left: 2px #dbdbdb solid;">
                {# Guardar #}
                <button id="save-button" type="button" class="btn filtering-buttons"> <img src="{{asset("media/save.png")}}" width="17px" height="18px"> &nbsp; {{('general.save')|trans|upper}}</button>
            </div>
            {% endif %}
        </div>
        {# ################################################## #}

        <hr id="datatable_hr" class="datatable_hr" style="margin-bottom: 20px;">

        <!--Panel Datos de Operario-->
        <div class="panel">
            <!--Panel heading-->
            <div id="operator_data_heading" class="panel-heading custom_collapse_panel_heading" data-target="#operator_data_body" data-toggle="collapse">
                <div class="panel-control">
                    <button class="btn btn-default" ><i class="fa fa-chevron-down"></i></button>
                </div>
                <h3 class="panel-title" style="font-weight: 600;">{{'detail_operator.operator_data'|trans}}</h3>
            </div>
            <!--Panel body-->
            <div id="operator_data_body" class="collapse in">
                <div class="panel-body">
                    <div id="operator_data_body_inner_row_div" class="row" style="margin: 0; font-size: 16px;">
                        <div class="col-sm-8 col-md-8 col-lg-6">
                            {# Identificador #}
                            <div class="col-sm-6 col-md-6 col-lg-6" style="margin-bottom: 20px; margin-top: 20px;">
                                <label for="reference-input" class="asitur_label regular_label" style="margin-bottom: 17px;">{{"detail_operator.input.label.reference"|trans}}</label>
                                {% if mode == "read_only" %}
                                    <br/>
                                    <p class="labelGrey_16">{{ operator.reference }}</p>
                                {% else %}
                                    <input id="reference-input" name="reference" value="{{ operator.reference }}" type="text" class="form-control asitur_input data_input" spellcheck="false" maxlength="50">
                                {% endif %}
                            </div>
                            {# Móvil #}
                            <div class="col-sm-6 col-md-6 col-lg-6" style="margin-bottom: 20px; margin-top: 20px;">
                                <label for="mobile-input" class="asitur_label regular_label" style="margin-bottom: 17px;">{{"detail_operator.input.label.mobile_phone"|trans}}</label>
                                {% if mode == "read_only" %}
                                    <div style="display: flex;">
                                        <br/>
                                        <p class="labelGrey_16">{{ operator.mobile }}</p>

                                        <div style="margin-left: 20px;">
                                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                                {% if smsDelivered == true %}
                                                    <img src="{{asset("media/check_revert.png")}}" width="24px" height="24px">
                                                    <span style="color: var(--main-green); margin-left: 15px;">{{"detail_operator.sms.sent"|trans}}</span>
                                                {% else %}
                                                    <img src="{{asset("media/equis.png")}}" width="24px" height="24px" style="filter: invert(20%) sepia(100%) saturate(6640%) hue-rotate(359deg) brightness(94%) contrast(118%);">
                                                    <span style="color: red; margin-left: 15px;">{{"detail_operator.sms.not_sent"|trans}}</span>
                                                {% endif %}
                                            </div>
                                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                                {% if loginAfterModification == true %}
                                                    <img src="{{asset("media/check_revert.png")}}" width="24px" height="24px">
                                                    <span style="color: var(--main-green); margin-left: 15px;">{{"detail_operator.login.check"|trans}}</span>
                                                {% else %}
                                                    <img src="{{asset("media/equis.png")}}" width="24px" height="24px" style="filter: invert(20%) sepia(100%) saturate(6640%) hue-rotate(359deg) brightness(94%) contrast(118%);">
                                                    <span style="color: red; margin-left: 15px;">{{"detail_operator.login.check"|trans}}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                        <input id="mobile-input" name="mobile" value="{{ operator.mobile }}" type="text" class="form-control asitur_input data_input" spellcheck="false" maxlength="20">
                                {% endif %}
                            </div>
                        </div>
                        {# Foto perfil #}
                        <div class="col-sm-4 col-md-4 col-lg-6">
                            <input type="file" id="profilePicToImport" name="profilePic[]" class="hidden">
                            <div id="profile_img_div" class="col-sm-6 col-md-2 col-lg-2 attachment_icon_img {% if mode == "edit_allowed" %}profile_icon{% endif %}" style="float: right; margin: 10px 12px 5px 12px; cursor: default; padding: 0 !important;">
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--Panel Grúa asignada-->
        <div class="panel">
            <!--Panel heading-->
            <div id="assigned_crane_heading" class="panel-heading custom_collapse_panel_heading" data-target="#assigned_crane_body" data-toggle="collapse">
                <div class="panel-control">
                    <button class="btn btn-default" ><i class="fa fa-chevron-down"></i></button>
                </div>
                <h3 class="panel-title" style="font-weight: 600;">{{'detail_operator.assigned_crane'|trans}}</h3>
            </div>
            <!--Panel body-->
            <div id="assigned_crane_body" class="collapse in">
                <div class="panel-body">
                    {% if mode == "read_only" %}
                        <div class="row">
                            <div class="col-sm-12 col-md-6 col-lg-6" style="display: flex; flex-wrap: no-wrap;">
                                <div class="labelGrey" style="margin-bottom: 20px; font-weight: normal;">{{"detail_operator.available_cranes"|trans}}:</div>
                                <div style="display: flex; flex-direction: column; font-size: 16px; margin-left: 10px; font-weight: bold;">
                                {% for opAvCrane in operatorAvailableCranes %}
                                    <li class="labelGrey_16">{{opAvCrane.crane.reference}}</li>
                                {% endfor %}
                                </div>
                            </div>
                            <div class="col-sm-12 col-md-6 col-lg-6" style="display: flex; flex-wrap: no-wrap;">
                                <div class="labelGrey" style="margin-bottom: 20px; font-weight: normal;">{{"detail_operator.assigned_crane"|trans}}:</div>
                                <div style="display: flex; font-size: 16px; margin-left: 10px; font-weight: bold;">
                                    {% if operator.crane is null %}
                                        <span class="labelGrey_16">{{"detail_operator.select.assigned_crane.placeholder"|trans}}</span>
                                    {% else %}
                                        <span class="labelGrey_16">{{operator.crane.reference}}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="row" style="margin: 0; font-size: 16px;">
                            <div class="row" style="padding: 0; display: flex; align-items: baseline; flex-wrap: wrap;">
                                <div class="labelGrey" style="margin-bottom: 20px;">{{"detail_operator.assigned_crane.subtext"|trans}}:</div>
                                <div style="display: flex; align-items: center;">
                                    <div style="display: flex; align-items: center; margin-left: 20px; margin-bottom: 20px;">
                                        <label for="branchOffice-input" class="filter_labels" style="font-weight: bold; margin-right: 10px; margin-bottom: 0px; height: 35px;">{{"modal.operator.label.branch_office"|trans|upper}}:</label>
                                        <select id="branchOffice-input" name="branchOffice" class="form-control filter_inputs select_inputs chosen-select">
                                            <option value=""> {{"detail_operator.select.branch_office.placeholder"|trans}} </option>
                                            {% for branchOffice in branchOfficesList %}
                                                <option value="{{ branchOffice.id }}"> {{ branchOffice.name }} </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div style="display: flex; align-items: center; margin-left: 20px; margin-bottom: 20px;">
                                        <label for="craneType-input" class="filter_labels" style="font-weight: bold; margin-right: 10px; margin-bottom: 0px; height: 35px;">{{"modal.input.crane.type"|trans|upper}}:</label>
                                        <select id="craneType-input" name="craneType" class="form-control filter_inputs select_inputs chosen-select">
                                            <option value=""> {{"detail_operator.select.crane_type.placeholder"|trans}} </option>
                                            {% for craneType in availableCraneTypesByBranchOffice %}
                                                <option value="{{ craneType.id }}"> {{ craneType.description }} </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {# Añadir grúa disponible #}
                        <div class="row" style="margin-bottom: 10px;">
                            <button disabled type="button" class="btn top_left-buttons new-button" style="border: 1px solid var(--main-blue); border-width: 2px !important;"> <img src="{{asset("media/datatables/icon-add.png")}}" width="17px" height="18px"> &nbsp; {{('general.add')|trans}}</button>
                        </div>
                        {# DataTable #}
                        <div class="row">
                            <table id="table_cranes" class="table">
                                <thead>
                                    <tr>
                                        <th><input type='checkbox' class='checkboxFullList imgCheckbox'/></th>
                                        <th>{{"dataTable.cranes.reference"|trans}}</th>
                                        <th>{{"dataTable.cranes.plate"|trans}}</th>
                                        <th>{{"dataTable.cranes.brand"|trans}}</th>
                                        <th>{{"dataTable.cranes.model"|trans}}</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                        <div class="row">
                            <div class="col-sm-12 col-md-6 col-lg-6">
                                <div class="labelGrey row" style="margin-bottom: 20px; margin-top: 20px;">{{"detail_operator.available_cranes"|trans}}:</div>
                                <div id="avCranesDivToAppend" class="col-sm-12 col-md-6 col-lg-6">

                                </div>
                            </div>
                            <div class="col-sm-12 col-md-6 col-lg-6">
                                <div class="labelGrey" style="margin-bottom: 20px; margin-top: 20px;">{{"detail_operator.assigned_crane"|trans}}:</div>
                                <select id="assignedCrane-input" name="assignedCrane" class="form-control filter_inputs select_inputs chosen-select">
                                    <option value=""> {{"detail_operator.select.assigned_crane.placeholder"|trans}} </option>
                                    
                                </select>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!--Panel Disponibilidad-->
        <div class="panel">
            <!--Panel heading-->
            <div id="operator_availability_heading" class="panel-heading custom_collapse_panel_heading" data-target="#operator_availability_body" data-toggle="collapse">
                <div class="panel-control">
                    <button class="btn btn-default" ><i class="fa fa-chevron-down"></i></button>
                </div>
                <h3 class="panel-title" style="font-weight: 600;">{{'detail_operator.operator_availability'|trans}}</h3>
            </div>
            <!--Panel body-->
            <div id="operator_availability_body" class="collapse in">
                <div class="panel-body">
                    <div class="row" style="margin: 0; font-size: 16px;">
                        {% if operator.availabilityOperatorStatus.id == 1 %}
                            <div>
                                <span class="switch_span_off" style="margin-right: 5px; vertical-align: middle; color: var(--main-grey);">OFF</span>
                                <input class="check_operator_status switchery" type="checkbox" checked>
                                <span class="switch_span_on" style="margin-left: 5px; font-weight: bold; vertical-align: middle; color: var(--main-grey);">ON</span>
                            </div>
                        {% else %}
                            <div>
                                <span class="switch_span_off" style="margin-right: 5px; font-weight: bold; vertical-align: middle; color: var(--main-grey);">OFF</span>
                                <input class="check_operator_status switchery" type="checkbox">
                                <span class="switch_span_on" style="margin-left: 5px; vertical-align: middle; color: var(--main-grey);">ON</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!--Panel Sucursales atendidas-->
        <div class="panel">
            <!--Panel heading-->
            <div id="attended_branch_offices_heading" class="panel-heading custom_collapse_panel_heading" data-target="#attended_branch_offices_body" data-toggle="collapse">
                <div class="panel-control">
                    <button class="btn btn-default" ><i class="fa fa-chevron-down"></i></button>
                </div>
                <h3 class="panel-title" style="font-weight: 600;">{{'detail_crane.attended_branch_offices'|trans}}</h3>
            </div>
            <!--Panel body-->
            <div id="attended_branch_offices_body" class="collapse in">
                <div class="panel-body">
                    <div class="row" style="margin: 0; font-size: 16px;">
                        <div class="col-sm-12 col-md-12 col-lg-12" style="margin-bottom: 20px;">
                            <p class="labelGrey">{{"detail_operator.attended_branch_offices.subtext"|trans}}:</p>
                        </div>
                    </div>
                    <div class="row" style="margin: 0; font-size: 16px;">
                        {% if mode == "read_only" %}
                            {% for branchOffice in collaboratorBranchOffices %}
                                <div class="col-sm-6 col-md-4 col-lg-3" style="margin-bottom: 20px;">
                                    {% if branchOffice.id in operatorBranchOffices %}
                                        <img style="margin-right: 5px;" src="{{asset("media/check.png")}}">
                                        <span class="labelGrey">{{branchOffice.name}}</span>
                                    {% else %}
                                        <img style="margin-right: 5px;" src="{{asset("media/uncheck.png")}}">
                                        <span class="labelGrey">{{branchOffice.name}}</span>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% else %}
                            {% for branchOffice in collaboratorBranchOffices %}
                            <div class="col-sm-6 col-md-4 col-lg-3" style="margin-bottom: 20px; display: flex; align-items: center;">
                                {% if branchOffice.id in operatorBranchOffices %}
                                    <input type='checkbox' class='checkboxBranchOffice imgCheckbox' data-branchoffice='{{branchOffice.id}}' checked/>
                                    <span class="labelGrey" style="margin-left: 10px;">{{branchOffice.name}}</span>
                                {% else %}
                                    <input type='checkbox' class='checkboxBranchOffice imgCheckbox' data-branchoffice='{{branchOffice.id}}'/>
                                    <span class="labelGrey" style="margin-left: 10px;">{{branchOffice.name}}</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% if mode == "edit_allowed" %}
            <!--Panel Cambiar contraseña-->
            <div class="panel">
                <!--Panel heading-->
                <div id="operator_password_heading" class="panel-heading custom_collapse_panel_heading" data-target="#operator_password_body" data-toggle="collapse">
                    <div class="panel-control">
                        <button class="btn btn-default" ><i class="fa fa-chevron-down"></i></button>
                    </div>
                    <h3 class="panel-title" style="font-weight: 600;">{{'detail_operator.operator_password'|trans}}</h3>
                </div>
                <!--Panel body-->
                <div id="operator_password_body" class="collapse in">
                    <div class="panel-body">
                        <div class="row" style="margin: 0; font-size: 16px;">
                            <div class="col-sm-6 col-md-5 col-lg-3">
                                <button id='btnChangePassword' class='btnDefaultMini' style='margin-bottom: 15px;'>{{"change_password.form.new_password"|trans}}</button>
                                <div id='changePasswordContent'>
                                    <div style='margin-bottom: 15px;'>
                                        <input id='password' type='password' name="password" class='form-control filter_inputs data_input' style="width: 100%;" placeholder='{{"detail_operator.change_password"|trans}}' value=''/>
                                    </div>
                                    <div>
                                        <input id='password2' type='password' name="password2" class='form-control filter_inputs data_input' style="width: 100%;" placeholder='{{"detail_operator.change_password_check"|trans}}' value=''/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <!--Panel Anexo de documentos-->
        <div class="panel">
            <!--Panel heading-->
            <div id="attachments_heading" class="panel-heading custom_collapse_panel_heading" data-target="#attachments_body" data-toggle="collapse">
                <div class="panel-control">
                    <button class="btn btn-default" ><i class="fa fa-chevron-down"></i></button>
                </div>
                <h3 class="panel-title" style="font-weight: 600;">{{'detail.attachments'|trans}}</h3>
            </div>
            <!--Panel body-->
            <div id="attachments_body" class="collapse in">
                <input type="file" id="fileToImport" name="attachment[]" class="hidden">
                <div id="attachments_panel_body" class="panel-body row" style="display: flex; justify-content: flex-start; flex-wrap: wrap;">
                    {% if mode == "edit_allowed" %}
                    <div id="import_file" class="attachment_icon_img attachment_icon_import">
                        <img src="{{asset("media/import_file.png")}}">
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <form id="save_redirect_form" action="{{ path('detail_operator') }}" method="POST" style="display: none;">
            <input type="hidden" name="operatorId" value="{{ operator.id }}">
            <input type="hidden" name="mode" value="read_only">
        </form>

    </div>
    <!--===================================================-->
    <!--End page content-->

{% endblock %}

{% block javascripts %}
    {{parent()}}
    <script>
        var arrayChecked = [];
        var arrayCheckedReferences = [];
        var availableCranes = [];
        var assignedCrane = null;

        {# Arrays que se utilizarán al guardar  #}
        var attachmentsToAdd = [];
        var attachmentsToRemove = [];
        var modifiedProfileImage = null;
        var branchOfficesSelected = [];
    
        $(document).ready(function(){

            $('#password').val('');
            $('#password2').val('');

            /*setInterval(function(){
                console.log("----->");
                console.log($('#password').val());
            },1000);*/

            var time = null;
            var html2 = "";

            {% for branchOffice in operatorBranchOffices %}
                branchOfficesSelected.push({{ branchOffice }});
            {% endfor %}

            let newAvAuxHtml = "";
            {% for opAvCrane in operatorAvailableCranes %}
                availableCranes.push({{ opAvCrane.crane.id }}); 

                newAvAuxHtml = '<div class="avCrane" style="margin-bottom: 17px; display: flex;">';
                newAvAuxHtml += '<div id="{{opAvCrane.crane.id}}" class="form-control asitur_input_to_delete" style="font-size: 16px;">{{opAvCrane.crane.reference}}</div>';
                newAvAuxHtml += '<div style="height: 35px; border-bottom: 1px solid lightgrey">';
                newAvAuxHtml += '<img class="asitur_input_to_delete-img av_crane_to_delete" data-id="{{opAvCrane.crane.id}}" data-reference="{{opAvCrane.crane.reference}}" src="{{asset("media/equis.png")}}" width="24px" height="24px">';
                newAvAuxHtml += '</div></div>';
                $("#avCranesDivToAppend").append(newAvAuxHtml);
            {% endfor %}

            {% if operator.crane is null %}
                assignedCrane = null;
            {% else %}
                assignedCrane = {{operator.crane.id}};
            {% endif %}

            reloadAssignedCraneChosen();

            $('.imgCheckbox').imgCheckbox({
                uncheckPath: "{{ asset('media/uncheck_empty.png') }}",
                checkPath: "{{ asset('media/check.png') }}"
            });

            var switch_elems = Array.prototype.slice.call(document.querySelectorAll('.check_operator_status'));

            if( "{{ mode }}" == "read_only" ) {
                switch_elems.forEach(function(html){
                    new Switchery(html, {disabled: true, 
                                         disabledOpacity: 1,
                                         color: "var(--main-blue)",
                                         secondaryColor: '#cdd3db'
                                        });
                });
            } else {
                switch_elems.forEach(function(html){
                    new Switchery(html, {disabled: false,
                                         color: "var(--main-blue)",
                                         secondaryColor: '#cdd3db'
                                        });
                });
            }

            $(".check_operator_status").change("checked", function() {
                if( $(this).prop("checked") ) {
                    $(".switch_span_on").css({"font-weight": "bold"});
                    $(".switch_span_off").css({"font-weight": "normal"});
                } else {
                    $(".switch_span_on").css({"font-weight": "normal"});
                    $(".switch_span_off").css({"font-weight": "bold"});
                }
            });

            $('#btnChangePassword').click(function(){
                $('#password').val('');
                $('#btnChangePassword').fadeOut(function(){
                    $('#changePasswordContent').fadeIn();
                });
            });

            $("#branchOffice-input").chosen({width: "220px !important"});
            $("#craneType-input").chosen({width: "220px !important"});
            $("#assignedCrane-input").chosen({width: "220px !important"});
            $("#reference-input").focus();

            $('#branchOffice-input').on('change', function(){
                $.ajax({
                    url:'{{ path("operator_crane_types_chosen_list") }}',
                    data: {
                        'branchOfficeId': $(this).val()
                    },
                    type:"POST",
                    success: function(json){
                        if (json.status){
                            $("#craneType-input").empty();
                            $("#craneType-input").append('<option value=""> {{"detail_operator.select.crane_type.placeholder"|trans}} </option>');
                            $.each(json.data, function (idx, obj) {
                                $("#craneType-input").append('<option value="' + obj.id + '">' + obj.description + '</option>');
                            });
                            $("#craneType-input").trigger("chosen:updated");
                            reloadDataTable();
                        } else {
                            swal.fire({
                                title: '{{ ("detail_operator.select.crane_type.error")|trans }}',
                                html: '',
                                icon: 'error',
                                showConfirmButton: true
                            });
                        }
                    },
                    error: function(err){
                        swal.fire({
                            title: '{{ ("detail_operator.select.crane_type.error")|trans }}',
                            html: '',
                            icon: 'error',
                            showConfirmButton: true
                        });
                    }
                });
            });

            $('#craneType-input').on('change', function(){
                reloadDataTable();
            });

            createTable();

            {#* Carga de la imagen de perfil #}
            let htmlProfilePicture = '<img class="profile_img_common" src="{{asset("media/empty_profile_picture.png")}}">';

            {% if operatorProfileImage != null %}
                let fileName = '{{ operatorProfileImage.fileName }}';
                let fileExtension = fileName.split('.').pop();
                let imageExtensions = ['png', 'jpg', 'jpeg', 'gif'];

                if( imageExtensions.includes(fileExtension) ) {

                    htmlProfilePicture = '<img class="profile_img profile_img_common" src="data:image/'+ fileExtension +';base64, '+ '{{ operatorProfileImage.fileData }}' +'" style="cursor: pointer; margin-bottom: 0 !important;" data-id="'+ '{{ operatorProfileImage.id }}' +'">';
                }
            {% endif %}
                htmlProfilePicture += '<div class="profile_img_camera_div" style="width: 120px; height: 120px; display: flex; justify-content: center; align-items: center; position: absolute; top: 0; left: 0; margin: 0px 15px; background-color: lightgrey; opacity: 0.75; border-radius: 5px; visibility: hidden; cursor: pointer;"><img class="profile_img_camera" src="{{asset("media/camara.png")}}" style="width: 40px; height: 40px; margin-bottom: 0;"></div>';

            $("#profile_img_div").append(htmlProfilePicture);
            {#* ############################ #}

            {#* Para que el apartado correspondiente en la barra lateral esté activo #}
            $("#data_management_li").addClass("active");
            {#* #################################################################### #}

            {#* Botón Editar #}
            $(".edit-button").click(function() {
                $("#edit_form").submit();
            });
            {#* ############ #}

            {#* Botón Eliminar #}
            $(".remove-button").click(function() {
                swal.fire({
                    title: '',
                    html: '{{"modal.operator.remove.individual"|trans}}',
                    icon: 'warning',
                    showConfirmButton: true,
                    confirmButtonText: "{{'modal.general.remove.confirm'|trans}}",
                    confirmButtonColor: "red",
                    focusConfirm: false,
                    allowEnterKey: false,
                    showCancelButton: true,
                    cancelButtonText: "{{'general.cancel'|trans}}"
                }).then((result) => {
                    if(result.isConfirmed) {
                        $.ajax({
                            url:'{{ path('operators_delete') }}',
                            data: {
                                'arrayChecked': ['{{ operator.id }}']
                            },
                            type:"POST",
                            success: function(data){
                                if (data.status){
                                    swal.fire({
                                        title: '{{ ("modal.general.operation.success")|trans }}',
                                        html: "",
                                        icon: 'success',
                                        showConfirmButton: false
                                    });
                                    setTimeout(function() {
                                        window.location.replace("{{ path('operators') }}");
                                    }, 1500);
                                } else {
                                    swal.fire({
                                        title: data.message,
                                        html: '',
                                        icon: 'error',
                                        showConfirmButton: true
                                    });
                                }
                            },
                            error: function(err){
                                swal.fire({
                                    title: '{{ ("modal.general.operation.error")|trans }}',
                                    html: '',
                                    icon: 'error',
                                    showConfirmButton: true
                                });
                            }
                        });
                    }
                });
            });
            {#* ############ #}

            {#* Exportación de un operario #}
            $(".export-button").click(function() {
                $.ajax({
                    url:'{{ path('detail_operator_export_excel') }}',
                    data: {
                        'form_filters': null,
                        'search_filter': null,
                        'operatorId': "{{ operator.id }}",
                    },
                    type:"POST",
                    success: function(data){
                        if (data.status){
                            swal.fire({
                                title: '{{ ("general.export.success")|trans }}',
                                html: "",
                                icon: 'success',
                                showConfirmButton: true
                            });

                            var fileName = data.data.fileName;
                            var filePath = data.data.filePath;
                            
                            var formTmp = document.createElement('form');
                            $(formTmp).attr('action',"{{ path('download_file') }}");
                            $(formTmp).attr('name','formTmp');
                            $(formTmp).attr('target','_blank');
                            $(formTmp).attr('enctype','multipart/form-data');
                            $(formTmp).attr('method','post');
                            $(formTmp).append("<input type='hidden' name='fileName' value='" + fileName + "'/>");
                            $(formTmp).append("<input type='hidden' name='filePath' value='" + filePath + "'/>");
                            document.body.appendChild(formTmp);
                            document.formTmp.submit();
                            document.body.removeChild(formTmp);
                        } else {
                            swal.fire({
                                title: '{{ ("general.export.error")|trans }}',
                                html: '',
                                icon: 'error',
                                showConfirmButton: true
                            });
                        }
                    },
                    error:function(err){
                        swal.fire({
                            title: '{{ ("general.export.error")|trans }}',
                            html: '',
                            icon: 'error',
                            showConfirmButton: true
                        });
                    }
                });
            });
            {#* ####################### #}

            {#* Botón guardar #}
            $("#save-button").click(function() {
                
                // ponemos esto por el autocompletado de chrome
                if($('#password2').val() == ''){
                    $('#password').val('');
                }
                
                if( $.trim($("#reference-input").val()) == "" ||
                    $.trim($("#mobile-input").val())    == ""
                ) {  
                    swal.fire({
                        title: '{{"general.form.allfields.mandatory"|trans}}',
                        html: '',
                        icon: 'error',
                        showConfirmButton: true
                    });
                } else if( ($("#password").val() != "" || $("#password2").val() != "") && 
                            $("#password").val() != $("#password2").val() ) {
                    swal.fire({
                        title: '{{"change_password.form.not_same"|trans}}',
                        html: '',
                        icon: 'error',
                        showConfirmButton: true
                    });
                } else {
                    var dataArray = {};

                    $(".data_input").each(function() {
                        dataArray[$(this).attr("name")] = $(this).val();
                    });

                    $.ajax({
                        url:'{{ path("detail_operator_edit_save") }}',
                        data: {
                            'operatorId': "{{ operator.id }}",
                            'dataArray': dataArray,
                            'availabilityStatus': $(".check_operator_status").prop("checked"),
                            'assignedCraneId': assignedCrane,
                            'availableCranes': availableCranes,
                            'branchOfficesSelected': branchOfficesSelected,
                            'attachmentsToAdd': attachmentsToAdd,
                            'attachmentsToRemove': attachmentsToRemove,
                            'modifiedProfileImage': modifiedProfileImage
                        },
                        type:"POST",
                        success: function(data){
                            if(data['status']) {
                                swal.fire({
                                    title: "{{'detail_crane.save.success'|trans}}",
                                    html: "",
                                    icon: 'success',
                                    showConfirmButton: true
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        $("#save_redirect_form").submit();
                                    }
                                });
                            } else {
                                swal.fire({
                                    title: data.message,
                                    html: '',
                                    icon: 'error',
                                    showConfirmButton: true
                                });
                            }
                        },
                        error:function(err){
                            swal.fire({
                                title: '{{ ("modal.general.operation.error")|trans }}',
                                html: '',
                                icon: 'error',
                                showConfirmButton: true
                            });
                        }
                    });
                }
            });
            {#* ############# #}

            {#* Botón añadir grúa disponible #}
            $(".new-button").click(function() {
                let newAvCraneHtml = "";

                $.each(arrayChecked, function (key, value) {
                    const index = availableCranes.indexOf(value);
                    if(index == -1) {
                        availableCranes.push(value);

                        newAvCraneHtml = '<div class="avCrane" style="margin-bottom: 17px; display: flex;">';
                        newAvCraneHtml += '<div id="'+ value +'" class="form-control asitur_input_to_delete" style="font-size: 16px;">'+ arrayCheckedReferences[key] +'</div>';
                        newAvCraneHtml += '<div style="height: 35px; border-bottom: 1px solid lightgrey">';
                        newAvCraneHtml += '<img class="asitur_input_to_delete-img av_crane_to_delete" data-id="'+ value +'" data-reference="'+ arrayCheckedReferences[key] +'" src="{{asset("media/equis.png")}}" width="24px" height="24px">';
                        newAvCraneHtml += '</div></div>';
                        $("#avCranesDivToAppend").append(newAvCraneHtml);
                    }  
                });

                $(".av_crane_to_delete").click(function(){
                    $(this).closest(".avCrane").remove();

                    const index = availableCranes.indexOf($(this).data("id"));
                    if(index > -1) {
                        availableCranes.splice(index, 1);
                    }
                    reloadAssignedCraneChosen();
                });
                reloadAssignedCraneChosen();
            });
            {#* ############# #}

            {#* Eliminar grúa disponible #}
            $(".av_crane_to_delete").click(function(){
                $(this).closest(".avCrane").remove();

                const index = availableCranes.indexOf($(this).data("id"));
                if(index > -1) {
                    availableCranes.splice(index, 1);
                }
                reloadAssignedCraneChosen();
            });
            {#* ######################## #}

            {#* Cambiar grúa asignada #}
            $("#assignedCrane-input").change(function(){
                assignedCrane = Number($(this).val());
            });
            {#* ######################## #}

            {% if mode == "read_only" %}
                {#* Descarga de un fichero adjunto #}
                $(".attachment_icon, .profile_img").click(function() {
                    var attachmentId = $(this).data("id");
                    $.ajax({
                        url:'{{ path('download_attachment') }}',
                        data: {
                            'attachmentId': attachmentId
                        },
                        type:"POST",
                        success: function(data){
                            if (data.status){
                                var fileName = data.data.fileName;
                                var filePath = data.data.filePath;
                                
                                var formTmp = document.createElement('form');
                                $(formTmp).attr('action',"{{ path('download_file') }}");
                                $(formTmp).attr('name','formTmp');
                                $(formTmp).attr('target','_blank');
                                $(formTmp).attr('enctype','multipart/form-data');
                                $(formTmp).attr('method','post');
                                $(formTmp).append("<input type='hidden' name='fileName' value='" + fileName + "'/>");
                                $(formTmp).append("<input type='hidden' name='filePath' value='" + filePath + "'/>");
                                document.body.appendChild(formTmp);
                                document.formTmp.submit();
                                document.body.removeChild(formTmp);
                            } else {
                                swal.fire({
                                    title: '{{ ("general.download.error")|trans }}',
                                    html: '',
                                    icon: 'error',
                                    showConfirmButton: true
                                });
                            }
                        },
                        error:function(err){
                            swal.fire({
                                title: '{{ ("general.download.error")|trans }}',
                                html: '',
                                icon: 'error',
                                showConfirmButton: true
                            });
                        }
                    });
                });
            {% else %}
                {#* Borra fichero adjunto (Lo añade a "attachmentsToRemove") #}
                $(".attachment_icon").click(function() {
                    swal.fire({
                        title: '',
                        html: '{{"modal.attachment.remove"|trans}}',
                        icon: 'warning',
                        showConfirmButton: true,
                        confirmButtonText: "{{'modal.general.remove'|trans}}",
                        confirmButtonColor: "red",
                        focusConfirm: false,
                        allowEnterKey: false,
                        showCancelButton: true,
                        cancelButtonText: "{{'general.cancel'|trans}}"
                    }).then((result) => {
                        if(result.isConfirmed) {
                            attachmentsToRemove.push($(this).data("id"));
                            $(this).remove();
                        }
                    });
                });

                {#* Modifica foto de perfil #}
                $("#profile_img_div").mouseenter(function(){
                    $(".profile_img_camera_div").css({"visibility": "visible"});
                });
                $("#profile_img_div").mouseleave(function(){
                    $(".profile_img_camera_div").css({"visibility": "hidden"});
                });

            {% endif %}

            {#* Ajax que obtiene la lista de ficheros adjuntos del operario #}
            $.ajax({
                url:'{{ path('operator_attachments') }}',
                data: {
                    'operatorId': "{{ operator.id }}"
                },
                type:"POST",
                success: function(data){
                    if(data.length) {
                        let html = "", fileExtension = "";
                        let imageExtensions = ['png', 'jpg', 'jpeg', 'gif'];
                        {% if mode == "read_only" %}
                            $.each(data, function (key, value) {
                                fileExtension = value["file_name"].split('.').pop();
                                if(value["file_name"].includes(".pdf")) {
                                    html += '<div class="attachment_icon attachment_icon_general" data-id="'+ value["id"] +'"> <img src="{{asset("media/file.png")}}">';
                                    html += '<div class="attachment_icon_text"> <span>'+ value["file_name"] +'</span> </div></div>';
                                } else if( imageExtensions.includes(fileExtension) ) {
                                    html += '<div class="attachment_icon attachment_icon_img" data-id="'+ value["id"] +'"> <img src="data:image/'+ fileExtension +';base64, '+ value["file_data"] +'">';
                                    html += '<div class="attachment_icon_text"> <span>'+ value["file_name"] +'</span> </div></div>';
                                } else {
                                    html += '<div class="attachment_icon attachment_icon_general" data-id="'+ value["id"] +'"> <img src="{{asset("media/file_general.png")}}">';
                                    html += '<div class="attachment_icon_text"> <span>'+ value["file_name"] +'</span> </div></div>';
                                }
                            }); 
                        {% else %}
                            $.each(data, function (key, value) {
                                fileExtension = value["file_name"].split('.').pop();
                                if(value["file_name"].includes(".pdf")) {
                                    html += '<div class="attachment_icon attachment_icon_general" data-id="'+ value["id"] +'" style="margin-top: -20px;"> <img src="{{asset("media/equis-azul.png")}}" class="delete_img_x"> <img src="{{asset("media/file.png")}}">';
                                    html += '<div class="attachment_icon_text"> <span>'+ value["file_name"] +'</span> </div></div>';
                                } else if( imageExtensions.includes(fileExtension) ) {
                                    html += '<div class="attachment_icon attachment_icon_img" data-id="'+ value["id"] +'" style="margin-top: -37px;"> <img src="{{asset("media/equis-azul.png")}}" class="delete_img_x" style="top: 14px; left: 60px;"> <img src="data:image/'+ fileExtension +';base64, '+ value["file_data"] +'">';
                                    html += '<div class="attachment_icon_text"> <span>'+ value["file_name"] +'</span> </div></div>';
                                } else {
                                    html += '<div class="attachment_icon attachment_icon_general" data-id="'+ value["id"] +'" style="margin-top: -20px;"> <img src="{{asset("media/equis-azul.png")}}" class="delete_img_x"> <img src="{{asset("media/file_general.png")}}">';
                                    html += '<div class="attachment_icon_text"> <span>'+ value["file_name"] +'</span> </div></div>';
                                }
                            }); 
                        {% endif %}

                        $("#attachments_panel_body").prepend(html);

                        {% if mode == "read_only" %}
                            {#* Descarga de un fichero adjunto #}
                            $(".attachment_icon").click(function() {
                                var attachmentId = $(this).data("id");
                                $.ajax({
                                    url:'{{ path('download_attachment') }}',
                                    data: {
                                        'attachmentId': attachmentId
                                    },
                                    type:"POST",
                                    success: function(data){
                                        if (data.status){
                                            var fileName = data.data.fileName;
                                            var filePath = data.data.filePath;
                                            
                                            var formTmp = document.createElement('form');
                                            $(formTmp).attr('action',"{{ path('download_file') }}");
                                            $(formTmp).attr('name','formTmp');
                                            $(formTmp).attr('target','_blank');
                                            $(formTmp).attr('enctype','multipart/form-data');
                                            $(formTmp).attr('method','post');
                                            $(formTmp).append("<input type='hidden' name='fileName' value='" + fileName + "'/>");
                                            $(formTmp).append("<input type='hidden' name='filePath' value='" + filePath + "'/>");
                                            document.body.appendChild(formTmp);
                                            document.formTmp.submit();
                                            document.body.removeChild(formTmp);
                                        } else {
                                            swal.fire({
                                                title: '{{ ("general.download.error")|trans }}',
                                                html: '',
                                                icon: 'error',
                                                showConfirmButton: true
                                            });
                                        }
                                    },
                                    error:function(err){
                                        swal.fire({
                                            title: '{{ ("general.download.error")|trans }}',
                                            html: '',
                                            icon: 'error',
                                            showConfirmButton: true
                                        });
                                    }
                                });
                            });
                        {% else %}
                            {#* Borra fichero adjunto (Lo añade a "attachmentsToRemove") #}
                            $(".attachment_icon").click(function() {
                                swal.fire({
                                    title: '',
                                    html: '{{"modal.attachment.remove"|trans}}',
                                    icon: 'warning',
                                    showConfirmButton: true,
                                    confirmButtonText: "{{'modal.general.remove'|trans}}",
                                    confirmButtonColor: "red",
                                    focusConfirm: false,
                                    allowEnterKey: false,
                                    showCancelButton: true,
                                    cancelButtonText: "{{'general.cancel'|trans}}"
                                }).then((result) => {
                                    if(result.isConfirmed) {
                                        attachmentsToRemove.push($(this).data("id"));
                                        $(this).remove();
                                    }
                                });
                            });
                        {% endif %}
                    }
                },
                error:function(err){
                    swal.fire({
                        title: '{{ ("attachment.list.error")|trans }}',
                        html: '',
                        icon: 'error',
                        showConfirmButton: true
                    });
                }
            });
            {#* ############################################################# #}

            {#* Importar fichero #}
            {% if mode == "edit_allowed" %}
                $("#fileToImport").dropzone({
                    url: "{{ path('preupload_attachment') }}",
                    addRemoveLinks: false,
                    maxFilesize: 150, //MB
                    autoProcessQueue: true, // ajuste cola
                    timeout: 180000, /*milliseconds*/
                    acceptedFiles: ".pdf, .jpg, .png, .jpeg, .txt, .PDF, .JPG, .PNG, .JPEG, .TXT",
                    maxFiles: 1,
                    parallelUploads: 5,
                    paramName: "file", // The name that will be used to transfer the file
                    clickable: '.attachment_icon_import',
                    init: function(){
                        // config
                        this.options.dictRemoveFile = "Delete";

                        this.on("success", function(file, responseText) {

                            auxHtml = '<div class="attachment_imported attachment_icon_general" data-filename="'+ responseText.data["fileName"] +'" data-path="'+ responseText.data["filePath"] +'" style="margin-top: -20px;"> <img src="{{asset("media/equis-azul.png")}}" class="delete_img_x"> <img src="{{asset("media/file_imported.png")}}">';
                            auxHtml += '<div class="attachment_icon_text"> <span>'+ responseText.data["fileName"] +'</span> </div></div>';
                            $("#attachments_panel_body").prepend(auxHtml);

                            attachmentsToAdd.push({ "fileName": responseText.data["fileName"], "filePath": responseText.data["filePath"] });
                            
                            {#* Borra fichero adjunto (Lo borra de "attachmentsToAdd") #}
                            $(".attachment_imported").click(function() {
                                swal.fire({
                                    title: '',
                                    html: '{{"modal.attachment.remove"|trans}}',
                                    icon: 'warning',
                                    showConfirmButton: true,
                                    confirmButtonText: "{{'modal.general.remove'|trans}}",
                                    confirmButtonColor: "red",
                                    focusConfirm: false,
                                    allowEnterKey: false,
                                    showCancelButton: true,
                                    cancelButtonText: "{{'general.cancel'|trans}}"
                                }).then((result) => {
                                    if(result.isConfirmed) {
                                        for(const [index, elem] of attachmentsToAdd.entries()) {
                                            if (elem["fileName"] == $(this).data("filename")) {
                                                attachmentsToAdd.splice(index, 1);
                                                $(this).remove();
                                                break;
                                            }
                                        }
                                    }
                                });
                            });
                        });
                        this.on('complete',function(file){
                            this.removeAllFiles();
                        });
                    }
                });
            {% endif %}
            {#* ################ #}

            {#* Importar foto perfil #}
            {% if mode == "edit_allowed" %}
                $("#profilePicToImport").dropzone({
                    url: "{{ path('preupload_operator_profile_picture') }}",
                    addRemoveLinks: false,
                    maxFilesize: 150, //MB
                    autoProcessQueue: true, // ajuste cola
                    timeout: 180000, /*milliseconds*/
                    acceptedFiles: ".jpg, .png, .jpeg, .JPG, .PNG, .JPEG",
                    maxFiles: 1,
                    parallelUploads: 5,
                    paramName: "opProfileImage", // The name that will be used to transfer the file
                    clickable: '.profile_img_camera_div',
                    init: function(){
                        // config
                        this.options.dictRemoveFile = "Delete";

                        this.on("success", function(opProfileImg, responseText) {
                            $(".profile_img_common").attr('src', "data:"+ responseText.data["type"] +";base64, "+ responseText.data["content"]);
                            modifiedProfileImage = {"fileName": responseText.data["fileName"], "filePath": responseText.data["filePath"] };
                            if(!$(".profile_img_common").hasClass("profile_img")) {
                                $(".profile_img_common").addClass("profile_img");
                            }
                        });
                        this.on('complete',function(file){
                            this.removeAllFiles();
                        });
                    }
                });
            {% endif %}
            {#* ################ #}

            $('.checkboxFullList').change(function(){
                var active = false;
                if ($(this).is(":checked")) {
                    active = true;
                }
                
                $('.checkboxCranes').each(function(){
                    $(this).prop('checked', active);
                    $(this).trigger('update');
                    $(this).trigger('change');
                });// change

                if(arrayChecked.length > 0) {
                    $(".new-button").removeAttr("disabled");
                } else {
                    $(".new-button").attr("disabled","disabled");
                }
            });

            {#* Acción de actualización de checkboxes #}
            $('.checkboxBranchOffice').change(function(){
                var branch_office_id = $(this).data('branchoffice');
                if ($(this).is(":checked")){
                    if(!branchOfficesSelected.includes(branch_office_id)) {
                        branchOfficesSelected.push(branch_office_id);
                    }
                }
                else{
                    var index = branchOfficesSelected.indexOf(branch_office_id);
                    if (index > -1) {
                        branchOfficesSelected.splice(index, 1);
                    }
                }
            });
            {#* ####################### #}

        }); // document ready

        {# Creación Datatable #}
        function createTable() {
            tableClients = $('#table_cranes').DataTable({
                dom: "<'row'<'col-sm-12't>><'row'<'col-sm-5'l><'col-sm-7'p>>",
                order: [1, 'ASC'],
                searching: true,
                rowReorder: true,
                columnDefs: [
                    { orderable: true, className: 'reorder', targets: [1,2,3,4] },
                    { orderable: false, targets: [0] }
                ],
                lengthMenu: [
                    [10, 25, 50, 100, -1],
                    [10, 25, 50, 100, "{{('dataTable.general.lengthMenu.all')|trans}}"]
                ],
                responsive: false,
                autoWidth: false,
                scrollX: true,
                processing: false,
                serverSide: true,
                pagingType: "full_numbers",
                language: {
                    "sProcessing": "{{ ('dataTable.general.language.sProcessing ') | trans }}",
                    "sLengthMenu": "{{ ('dataTable.asitur.language.sLengthMenu') | trans}}: _MENU_",
                    "sZeroRecords": "{{ ('dataTable.general.language.sZeroRecords') | trans }}",
                    "sEmptyTable": "{{ ('dataTable.general.language.sZeroRecords') | trans }}",
                    "sInfo": "{{ ('dataTable.general.language.sInfo') | trans }}",
                    "sInfoEmpty": "{{ ('dataTable.general.language.sInfoEmpty') | trans }}",
                    "sInfoFiltered": "{{ ('dataTable.general.language.sInfoFiltered') | trans }}",
                    "sInfoPostFix": "",
                    "sSearch": "{{ ('dataTable.general.language.sSearch') | trans }}:",
                    "sUrl": "",
                    "sInfoThousands": ",",
                    "sLoadingRecords": "{{ ('dataTable.general.language.sLoadingRecords') | trans }}",
                    "oPaginate": {
                        "sFirst": "<<",
                        "sLast": ">>",
                        "sNext": ">",
                        "sPrevious": "<",
                    },
                    "oAria": {
                        "sSortAscending": ": {{ ('dataTable.general.language.oAria.sSortAscending') | trans }}",
                        "sSortDescending": ": {{ ('dataTable.general.language.oAria.sSortDescending') | trans }}"
                    },
                },
                ajax: {
                    url: "{{ path('operators_available_cranes_table') }}",
                    method: 'POST',
                    data: {
                        "operatorId": "{{ operator.id }}"
                    }
                },
                initComplete: function() {
                    // Enable THEAD scroll bars
                    $('.dataTables_scrollHead').css('overflow', 'auto');

                    // Sync THEAD scrolling with TBODY
                    $('.dataTables_scrollHead').on('scroll', function () {
                        $('.dataTables_scrollBody').scrollLeft($(this).scrollLeft());
                    });
                },
                drawCallback: function() {
                    // check checked
                    $('.checkboxCranes').each(function(){
                        var crane_id = $(this).data('crane');
                        var index = arrayChecked.indexOf(crane_id);
                        if (index > -1) {
                            $(this).prop('checked', true);
                        }
                    });

                    // recarga visual
                    reloadCheckbox();

                    // Acción de actualización
                    $('.checkboxCranes').change(function(){
                        var crane_id = $(this).data('crane');
                        var crane_reference = $(this).data('reference');
                        if ($(this).is(":checked")){
                            if(!arrayChecked.includes(crane_id)) {
                                arrayChecked.push(crane_id);
                                arrayCheckedReferences.push(crane_reference);
                            }
                            $(this).closest("tr").addClass("rowSelected");
                        } else {
                            var index = arrayChecked.indexOf(crane_id);
                            if (index > -1) {
                                arrayChecked.splice(index, 1);
                                arrayCheckedReferences.splice(index, 1);
                            }
                            $(this).closest("tr").removeClass("rowSelected");
                        }

                        if(arrayChecked.length > 0) {
                            $(".new-button").removeAttr("disabled");
                        } else {
                            $(".new-button").attr("disabled","disabled");
                        }
                    });// change
                },
                columns: [
                    {data: {}, render: function(data, row) {
                        var html = "<input type='checkbox' class='checkboxCranes imgCheckbox' data-crane='"+data.id+"' data-reference='"+data.reference+"'/>";
                        return html;
                        }
                    },
                    {data: 'reference'},
                    {data: 'plate'},
                    {data: 'brand'},
                    {data: 'model'}
                ]
            });
        }
        {# #### Datatable #### #}

        {# Función encargada de recargar el ajax del datatable #}
        let reloadDataTable = function() {
            var fullFilters = {
                'branchOfficeId': $("#branchOffice-input").val(),
                'craneTypeId': $("#craneType-input").val()
            }

            $("#table_cranes").DataTable().search(JSON.stringify(fullFilters)).draw();

            {#* Descomentar para que los checkboxes se reinicien al recargar el dataTable #}
            arrayChecked = [];
            arrayCheckedReferences = [];
            $(".new-button").attr('disabled', 'disabled');

        }
        {# ################################################### #}

        function reloadCheckbox(){
            $('.imgCheckbox').imgCheckbox({
                uncheckPath: "{{ asset('media/uncheck_empty.png') }}",
                checkPath: "{{ asset('media/check.png') }}"
            });

            $('.checkboxFullList').imgCheckbox({
                uncheckPath: "{{ asset('media/uncheck_empty.png') }}",
                checkPath: "{{ asset('media/check.png') }}"
            });
        }

        function reloadAssignedCraneChosen() {
            html2 = '<option value="">{{"detail_operator.select.assigned_crane.placeholder"|trans}}</option>';

            $(".asitur_input_to_delete-img").each(function() {
                html2 += '<option class="option_crane" data-id="'+ $(this).data("id") +'" value="'+ $(this).data("id") +'">'+ $(this).data("reference") +'</option>';
            });

            $("#assignedCrane-input").empty();
            $("#assignedCrane-input").append(html2);

            if(assignedCrane != null) {
                if(availableCranes.includes(assignedCrane)) { 
                    $("#assignedCrane-input").val(assignedCrane);
                }
            } else {
                $("#assignedCrane-input").val("");
            }

            $("#assignedCrane-input").trigger("chosen:updated");
        }

    </script>
{% endblock %}