{% extends 'includes/backend_sidebar.html.twig' %}

{% block title %}Asitur{% endblock %}

{% block stylesheets %}
{{parent()}}

{% endblock %}

{% block content %}

    <!--Page Title-->
    <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
    <div id="page-title">
        <h1 class="page-header text-overflow">{{"backend.email_log.header"|trans}}</h1>
    </div>
    <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
    <!--End page title-->

    <!--Page content-->
    <!--===================================================-->
    <div id="page-content">
        
        <div style="display: block;
                    margin-bottom: 10px;
                    margin-right: 24px;
                    margin-top: 20px;
                    float: right;">
            <label class="control-label">{{"general.search"|trans}}:</label>
            <input id="search-input" class='search-input' type="text" placeholder="{{"general.search"|trans}}..." spellcheck="false">
        </div>

        <!-- Tabla Log de emails -->
        <!--===================================================-->
        <div class="panel">
            <div class="panel-body">
                <table id="table_emails_log" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>{{"dataTable.email.log.intervention_id"|trans}}</th>
                            <th>{{"dataTable.email.log.subject"|trans}}</th>
                            <th>{{"dataTable.email.log.creation_date"|trans}}</th>
                            <th>{{"dataTable.email.log.email_to"|trans}}</th>
                            <th>{{"dataTable.email.log.email_cc"|trans}}</th>
                            <th>{{"dataTable.email.log.email_bcc"|trans}}</th>
                            <th>{{"dataTable.email.log.is_delivered"|trans}}</th>
                            <th>{{"dataTable.email.log.template"|trans}}</th>
                            <th>{{"dataTable.email.log.template_content"|trans}}</th>
                            <th>{{"dataTable.email.log.locale"|trans}}</th>
                            <th>{{"dataTable.email.log.backup"|trans}}</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
        <!--===================================================-->
    
    </div>
    <!--===================================================-->
    <!--End page content-->

{% endblock %}

{% block javascripts %}
    {{parent()}}

<script>
    $(document).ready(function(){

        var time = null;
        createTable();

        $('#search-input').keyup(function() {
            clearInterval(time);
            time = setTimeout(function() {
                reloadDataTable();
            }, 1500);
        });

    });

    function bindTableEvents() {

        $('.visualize').click(function(){
            var id = $(this).data("id");
            
            var formTmp = document.createElement('form');
            $(formTmp).attr('action',"{{ path('mail_show') }}");
            $(formTmp).attr('name','formTmp');
            $(formTmp).attr('target','_blank');
            $(formTmp).attr('method','post');
            $(formTmp).append("<input type='hidden' name='mailId' value='" + id + "'/>");
            document.body.appendChild(formTmp);
            document.formTmp.submit();

            document.body.removeChild(formTmp);

            /*
            $.ajax({
                url:"{{ path('mail_text_ajax') }}",
                type: 'post',
                data: {'id': id}
            })
            .done(function( data ) {
                
                swal.fire({
                    title: '',
                    html: '<h1>{{ ("general.loading")|trans }}...</h1>',
                    showConfirmButton: false,
                    timer: 300
                });

                var formTmp = document.createElement('form');
                $(formTmp).attr('action',"{{ path('mail_show') }}");
                $(formTmp).attr('name','formTmp');
                $(formTmp).attr('target','_blank');
                $(formTmp).attr('method','post');
                $(formTmp).append("<input type='hidden' name='content' value='" + data + "'/>");
                document.body.appendChild(formTmp);
                document.formTmp.submit();

                document.body.removeChild(formTmp);

            });
            */
        });
    }

    function createTable() {

        $('#table_emails_log').DataTable({
            order: [2, 'DESC'],
            searching: false,
            lengthMenu: [
                [10, 25, 50, 100, -1],
                [10, 25, 50, 100,
                    "{{('dataTable.general.lengthMenu.all')|trans}}"
                ]
            ],
            responsive: false,
            autoWidth: false,
            scrollX: true,
            processing: false,
            serverSide: true,
            pagingType: "full_numbers",
            language: {
                "sProcessing": "{{ 'dataTable.general.language.sProcessing' | trans }}",
                "sLengthMenu": "{{ ('dataTable.general.language.sLengthMenu') | trans}}",
                "sZeroRecords": "{{ ('dataTable.general.language.sZeroRecords') | trans }}",
                "sEmptyTable": "{{ ('dataTable.general.language.sZeroRecords') | trans }}",
                "sInfo": "{{ ('dataTable.general.language.sInfo') | trans }}",
                "sInfoEmpty": "{{ ('dataTable.general.language.sInfoEmpty') | trans }}",
                "sInfoFiltered": "{{ ('dataTable.general.language.sInfoFiltered') | trans }}",
                "sInfoPostFix": "",
                "sSearch": "{{ ('dataTable.general.language.sSearch') | trans }}:",
                "sUrl": "",
                "sInfoThousands": ",",
                "sLoadingRecords": "{{ ('dataTable.general.language.sLoadingRecords') | trans }}",
                "oPaginate": {
                    "sFirst": "{{ ('dataTable.general.language.oPaginate.sFirst') | trans }}",
                    "sLast": "{{ ('dataTable.general.language.oPaginate.sLast') | trans }}",
                    "sNext": "{{ ('dataTable.general.language.oPaginate.sNext') | trans }}",
                    "sPrevious": "{{ ('dataTable.general.language.oPaginate.sPrevious') | trans }}",
                },
                "oAria": {
                    "sSortAscending": ": {{ ('dataTable.general.language.oAria.sSortAscending') | trans }}",
                    "sSortDescending": ": {{ ('dataTable.general.language.oAria.sSortDescending') | trans }}"
                },
            },
            ajax: {
                url: "{{ path('email_logs_table') }}",
                method: 'POST',
                data: {
                    'form_filters': $('#table_emails_log').serialize(),
                    'search_filter': $('#search-input').val(),
                }
            },
            initComplete: function() {},
            drawCallback: function() {
                bindTableEvents();
            },
            columns: [
                {data: 'intervention_id'},
                {data: 'subject'},
                {data: 'creation_date'},
                {data: 'email_to'},
                {data: {}, render: function(data, row) {
                        if (data['email_cc'] == "[]") {
                            return "";
                        }
                        return data['email_cc'];
                    }
                },
                {data: {}, render: function(data, row) {
                        if (data['email_bcc'] == "[]") {
                            return "";
                        }
                        return data['email_bcc'];
                    }
                },
                {data: {}, render: function(data, row) {
                        let text;
                        if (data['is_delivered'] == 1) {
                            text = "{{"general.yes"|trans}}";
                        }
                        else {
                            text = "{{"general.no"|trans}}";
                        }
                        return text;
                    }
                },
                {data: 'template'},
                {data: {}, render: function(data, row) {
                        let html = "<div class='table-element' style='display:flex; justify-content:center;'>";
                        html += '<button class="btn visualize btn-info btn-icon icon-lg fa fa-search" data-id="' + data['id'] + '" style="width: 75%;"></button></div>'
                    
                        return html;
                    }
                },
                {data: 'locale'},
                {data: 'backup'}
            ]
        });
    }

    {# Funci√≥n encargada de recargar el ajax del datatable #}
    let reloadDataTable = function() {
        $("#table_emails_log").DataTable().destroy();
        createTable();
    }
    {# ################################################### #}

</script>


{% endblock %}